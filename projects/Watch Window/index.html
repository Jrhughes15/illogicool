<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="UTF-8" />

  <title>Watch Window</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>

    * {

      box-sizing: border-box;

    }



    body {

      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      margin: 0;

      padding: 0;

      background: #0f172a;

      color: #e5e7eb;

    }



    header {

      padding: 1.5rem 1.5rem 0.75rem;

      text-align: center;

    }



    header h1 {

      margin: 0;

      font-size: 1.6rem;

    }



    header p {

      margin: 0.4rem 0 0;

      font-size: 0.9rem;

      color: #9ca3af;

    }



    main {

      max-width: 900px;

      margin: 0 auto 3rem;

      padding: 0 1.5rem 1.5rem;

    }



    .card {

      background: #020617;

      border-radius: 0.75rem;

      padding: 1rem 1.25rem 1.25rem;

      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);

      border: 1px solid #1f2937;

    }



    form {

      display: grid;

      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));

      gap: 0.75rem 1rem;

      align-items: flex-end;

    }



    .field {

      display: flex;

      flex-direction: column;

      gap: 0.35rem;

    }



    label {

      font-size: 0.8rem;

      text-transform: uppercase;

      letter-spacing: 0.05em;

      color: #9ca3af;

    }



    input[type="text"],

    input[type="number"] {

      padding: 0.5rem 0.6rem;

      border-radius: 0.5rem;

      border: 1px solid #4b5563;

      background: #020617;

      color: #e5e7eb;

      font-size: 0.9rem;

    }



    select {

      padding: 0.5rem 0.6rem;

      border-radius: 0.5rem;

      border: 1px solid #4b5563;

      background: #020617;

      color: #e5e7eb;

      font-size: 0.9rem;

    }



    input[type="number"]::-webkit-inner-spin-button,

    input[type="number"]::-webkit-outer-spin-button {

      -webkit-appearance: none;

      margin: 0;

    }



    input[type="number"] {

      -moz-appearance: textfield;

    }



    input:focus {

      outline: none;

      border-color: #38bdf8;

      box-shadow: 0 0 0 1px #38bdf8;

    }



    .field-inline-note {

      font-size: 0.7rem;

      color: #6b7280;

    }



    .field-inline-check {

      display: flex;

      align-items: center;

      gap: 0.4rem;

      font-size: 0.85rem;

      color: #e5e7eb;

    }



    button {

      padding: 0.65rem 1.1rem;

      border-radius: 0.75rem;

      border: none;

      background: linear-gradient(135deg, #38bdf8, #6366f1);

      color: white;

      font-weight: 600;

      font-size: 0.95rem;

      cursor: pointer;

      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;

      white-space: nowrap;

    }



    button:hover {

      transform: translateY(-1px);

      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);

      opacity: 0.95;

    }



    button:disabled {

      opacity: 0.6;

      cursor: default;

      box-shadow: none;

      transform: none;

    }



    .ghost-btn {

      background: #0b1222;

      border: 1px solid #334155;

      color: #e5e7eb;

      box-shadow: none;

    }



    .ghost-btn:disabled {

      opacity: 0.5;

    }



    .results-actions {

      margin: 0.5rem 0;

      display: flex;

      gap: 0.5rem;

      flex-wrap: wrap;

    }



    .load-more-row {

      display: flex;

      justify-content: center;

      margin-top: 0.75rem;

    }



    .status {

      margin-top: 0.75rem;

      font-size: 0.8rem;

      color: #9ca3af;

    }



    .results-meta {

      margin-top: 1rem;

      font-size: 0.8rem;

      color: #9ca3af;

    }



    .results {

      margin-top: 0.75rem;

      display: grid;

      gap: 0.75rem;

    }



    .section-heading {

      margin-top: 0.75rem;

      font-size: 0.95rem;

      font-weight: 700;

      color: #e5e7eb;

    }



    .inline-player {

      margin-top: 0.5rem;

      background: #0b1222;

      border: 1px solid #1f2937;

      border-radius: 0.75rem;

      padding: 0.75rem;

      display: none;

    }



    .inline-player iframe {

      width: 100%;

      aspect-ratio: 16 / 9;

      border: none;

      border-radius: 0.5rem;

      background: #020617;

    }



    .player-meta {

      margin-top: 0.5rem;

      font-size: 0.85rem;

      color: #9ca3af;

    }



    .result-item {

      display: grid;

      grid-template-columns: auto 1fr;

      gap: 0.75rem;

      padding: 0.6rem;

      border-radius: 0.75rem;

      background: #020617;

      border: 1px solid #1f2937;

      align-items: center;

    }



    .thumb {

      width: 140px;

      aspect-ratio: 16 / 9;

      border-radius: 0.5rem;

      overflow: hidden;

      background: #020617;

      border: 1px solid #111827;

    }



    .thumb img {

      width: 100%;

      height: 100%;

      object-fit: cover;

      display: block;

    }



    .video-info {

      display: flex;

      flex-direction: column;

      gap: 0.25rem;

    }



    .video-title {

      font-size: 0.95rem;

      font-weight: 600;

      color: #e5e7eb;

    }



    .video-meta {

      font-size: 0.8rem;

      color: #9ca3af;

    }



    .video-actions {

      margin-top: 0.25rem;

      display: flex;

      gap: 0.5rem;

      flex-wrap: wrap;

      align-items: center;

    }



    .pill {

      display: inline-flex;

      align-items: center;

      justify-content: center;

      padding: 0.2rem 0.55rem;

      border-radius: 999px;

      font-size: 0.75rem;

      border: 1px solid #4b5563;

      color: #e5e7eb;

    }



    .pill-ok {

      border-color: #22c55e;

      color: #bbf7d0;

    }



    .pill-off {

      border-color: #f97316;

      color: #fed7aa;

    }



    .link-btn {

      display: inline-flex;

      align-items: center;

      justify-content: center;

      padding: 0.3rem 0.7rem;

      border-radius: 999px;

      font-size: 0.78rem;

      border: 1px solid #38bdf8;

      color: #e0f2fe;

      text-decoration: none;

    }



    .link-btn:hover {

      background: rgba(56, 189, 248, 0.08);

    }



    .error {

      margin-top: 0.75rem;

      font-size: 0.8rem;

      color: #fecaca;

    }



    .hint {

      margin-top: 0.5rem;

      font-size: 0.75rem;

      color: #6b7280;

    }



    @media (max-width: 640px) {

      .result-item {

        grid-template-columns: 1fr;

      }



      .thumb {

        width: 100%;

      }

    }



    .small-btn {
      padding: 0.4rem 0.7rem;
      font-size: 0.82rem;
    }

    body.light {
      background: #f8fafc;
      color: #0f172a;
    }

    body.light .card {
      background: #ffffff;
      border-color: #e5e7eb;
      color: #0f172a;
    }

    body.light input[type="text"],
    body.light input[type="number"],
    body.light select {
      background: #ffffff;
      color: #0f172a;
      border-color: #cbd5e1;
    }

    body.light .results-meta,
    body.light .status,
    body.light .video-meta {
      color: #475569;
    }

    body.light .result-item {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    body.light .thumb {
      border-color: #e5e7eb;
      background: #f8fafc;
    }

    body.light .ghost-btn {
      background: #ffffff;
      border-color: #cbd5e1;
      color: #0f172a;
    }
  </style>

</head>

<body>

  <header>

    <h1>Watch Window</h1>

    <p>Find videos that match your interests and fit the time you actually have.</p>
    <button type="button" id="themeToggle" class="ghost-btn small-btn">Light mode</button>

  </header>



  <main>

    <section class="card">

      <form id="searchForm">

        <div class="field" style="grid-column: 1 / -1;">

          <label for="query">Topic or interest</label>

          <input

            type="text"

            id="query"

            placeholder="Example: tech reviews, cooking tips, travel guides"

            required

          />

        </div>



        <div class="field">

          <label for="minutes">Target length (minutes)</label>

          <input

            type="number"

            id="minutes"

            min="1"

            max="600"

            value="10"

            required

          />

          <div class="field-inline-note">Example: 10 for a ten-minute video</div>

        </div>



        <div class="field">

          <label for="tolerance">Tolerance (+/- minutes)</label>

          <input

            type="number"

            id="tolerance"

            min="0"

            max="60"

            value="1"

          />

          <div class="field-inline-note">1 means 9 to 11 minutes is ok</div>

        </div>



        <div class="field">

          <label for="strictMatch">Strict match</label>

          <div class="field-inline-check">

            <input type="checkbox" id="strictMatch" />

            <span>Force exact length (ignores tolerance)</span>

          </div>

        </div>



        <div class="field">

          <label for="maxResults">Max search results</label>

          <input

            type="number"

            id="maxResults"

            min="5"

            max="50"

            value="25"

          />

        </div>



        <div class="field">

          <label for="sortMode">Sort</label>

          <select id="sortMode">

            <option value="relevance">Relevance</option>

            <option value="closest">Closest duration</option>

            <option value="views">Most views</option>

            <option value="date">Newest</option>

          </select>

        </div>



        <div class="field">

          <label for="published">Published</label>

          <select id="published">

            <option value="any">Any time</option>

            <option value="week">Past week</option>

            <option value="month">Past month</option>

            <option value="year">Past year</option>

          </select>

        </div>



        <div class="field">

          <label for="minViews">Min views</label>

          <input type="number" id="minViews" min="0" placeholder="e.g. 10000" />

        </div>



        <div class="field">

          <label for="minLikes">Min likes</label>

          <input type="number" id="minLikes" min="0" placeholder="e.g. 500" />

        </div>



        <div class="field">

          <label for="definition">Quality</label>

          <select id="definition">

            <option value="any">Any</option>

            <option value="hd">HD only</option>

          </select>

        </div>



        <div class="field">

          <label for="excludeShorts">Exclude shorts</label>

          <div class="field-inline-check">

            <input type="checkbox" id="excludeShorts" checked />

            <span>Filter out videos under 1 minute</span>

          </div>

        </div>



        <div class="field">

          <label for="recentSelect">Recent searches</label>

          <select id="recentSelect">

            <option value="">-</option>

          </select>

        </div>



        <div class="field">

          <button type="submit" id="submitBtn">Find videos</button>

        </div>

      </form>



      <div class="status" id="status"></div>

      <div class="error" id="error"></div>

    
      <div class="results-meta" id="resultsMeta"></div>

      <div class="results-actions">

        <button type="button" id="playlistBtn" class="ghost-btn" disabled>Open playlist on YouTube</button>

        <button type="button" id="copySearchBtn" class="ghost-btn" disabled>Copy search link</button>

      </div>

      <div class="results" id="results"></div>

      <div class="load-more-row">

        <button type="button" id="loadMoreBtn" class="ghost-btn">Load more</button>

      </div>

    </section>

  </main>



  <script>

    // 1. Put your API key here

    // Get one from Google Cloud Console and enable YouTube Data API v3.

    const YT_API_KEY = "AIzaSyBledC8TyQM3iCxZDIbwrZQVUuBjYBhVvc";



    const searchForm = document.getElementById("searchForm");

    const statusEl = document.getElementById("status");

    const errorEl = document.getElementById("error");

    const resultsMetaEl = document.getElementById("resultsMeta");

    const resultsEl = document.getElementById("results");

    const submitBtn = document.getElementById("submitBtn");

    const toleranceInput = document.getElementById("tolerance");

    const strictMatchInput = document.getElementById("strictMatch");

    const sortModeSelect = document.getElementById("sortMode");

    const publishedSelect = document.getElementById("published");

    const minViewsInput = document.getElementById("minViews");

    const minLikesInput = document.getElementById("minLikes");

    const definitionSelect = document.getElementById("definition");

    const excludeShortsInput = document.getElementById("excludeShorts");

    const recentSelect = document.getElementById("recentSelect");

    const playlistBtn = document.getElementById("playlistBtn");

    const copySearchBtn = document.getElementById("copySearchBtn");

    const loadMoreBtn = document.getElementById("loadMoreBtn");

    const themeToggle = document.getElementById("themeToggle");



    const RECENT_KEY = "yt_time_match_recent";
    const THEME_KEY = "yt_time_match_theme";

    const RECENT_LIMIT = 8;



    let currentNextPageToken = null;

    let currentQuery = "";

    let currentParams = null;

    let collectedVideos = [];



    function setStatus(text) {

      statusEl.textContent = text || "";

    }



    function setError(text) {

      errorEl.textContent = text || "";

    }



    function clearResults() {

      resultsEl.innerHTML = "";

      resultsMetaEl.textContent = "";

    }



    function loadRecent() {

      try {

        const raw = localStorage.getItem(RECENT_KEY);

        return raw ? JSON.parse(raw) : [];

      } catch {

        return [];

      }

    }



    function persistRecent(list) {

      try {

        localStorage.setItem(RECENT_KEY, JSON.stringify(list));

      } catch {

        /* ignore */

      }

    }



    function seedRecentSelect() {

      const recent = loadRecent();

      recentSelect.innerHTML = '<option value="">-</option>';

      recent.forEach((item) => {

        const opt = document.createElement("option");

        opt.value = item;

        opt.textContent = item;

        recentSelect.appendChild(opt);

      });

    }



    function pushRecent(query) {

      if (!query) return;

      const recent = loadRecent();

      const existingIdx = recent.indexOf(query);

      if (existingIdx !== -1) recent.splice(existingIdx, 1);

      recent.unshift(query);

      if (recent.length > RECENT_LIMIT) recent.pop();

      persistRecent(recent);

      seedRecentSelect();

    }

    function applyTheme(theme) {
      const isLight = theme === "light";
      document.body.classList.toggle("light", isLight);
      themeToggle.textContent = isLight ? "Dark mode" : "Light mode";
    }

    function initTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const initial = stored === "light" || stored === "dark" ? stored : "dark";
      applyTheme(initial);
    }



    function parseISODurationToMinutes(iso) {

      // ISO 8601 format like "PT17M5S" or "PT1H4M12S"

      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);

      if (!match) return 0;

      const hours = parseInt(match[1] || "0", 10);

      const minutes = parseInt(match[2] || "0", 10);

      const seconds = parseInt(match[3] || "0", 10);

      return hours * 60 + minutes + seconds / 60;

    }



    function formatMinutesMinutesAndSeconds(totalMinutes) {

      const totalSeconds = Math.round(totalMinutes * 60);

      const hours = Math.floor(totalSeconds / 3600);

      const remaining = totalSeconds % 3600;

      const mins = Math.floor(remaining / 60);

      const secs = remaining % 60;



      const parts = [];

      if (hours > 0) {

        parts.push(hours + "h");

      }

      parts.push(mins + "m");

      if (secs > 0) {

        parts.push(secs + "s");

      }

      return parts.join(" ");

    }



    function formatDeltaMinutes(deltaMinutes) {

      if (deltaMinutes === 0) return "Perfect match";

      const totalSeconds = Math.round(Math.abs(deltaMinutes * 60));

      const mins = Math.floor(totalSeconds / 60);

      const secs = totalSeconds % 60;

      const sign = deltaMinutes > 0 ? "+" : "-";

      return sign + mins + "m " + secs.toString().padStart(2, "0") + "s";

    }



    function formatNumberShort(num) {

      const n = Number(num || 0);

      if (n >= 1_000_000) return (n / 1_000_000).toFixed(1).replace(/\.0$/, "") + "M";

      if (n >= 1_000) return (n / 1_000).toFixed(1).replace(/\.0$/, "") + "K";

      return n.toLocaleString();

    }



    function getPublishedAfterRange(value) {

      const now = new Date();

      if (value === "week") {

        now.setDate(now.getDate() - 7);

      } else if (value === "month") {

        now.setMonth(now.getMonth() - 1);

      } else if (value === "year") {

        now.setFullYear(now.getFullYear() - 1);

      } else {

        return "";

      }

      return now.toISOString();

    }



        function showInlinePlayer(container, video, { autoplay = true } = {}) {

      if (!container || !video || !video.id) return;



      container.innerHTML = "";

      const frame = document.createElement("iframe");

      frame.src =

        "https://www.youtube.com/embed/" +

        encodeURIComponent(video.id) +

        (autoplay ? "?autoplay=1" : "");

      frame.allow =

        "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";

      frame.allowFullscreen = true;

      frame.title = video.title || "YouTube video player";



      const meta = document.createElement("div");

      meta.className = "player-meta";

      meta.textContent =

        (video.title || "Playing video") +

        (video.channel ? " ? " + video.channel : "") +

        (Number.isFinite(video.durationMinutes)

          ? " ? " + formatMinutesMinutesAndSeconds(video.durationMinutes)

          : "");



      container.appendChild(frame);

      container.appendChild(meta);

      container.style.display = "block";

      container.dataset.visible = "true";

      container.dataset.videoId = video.id;

    }



function toggleInlinePlayer(container, video) {

      if (!container) return;

      const isVisible = container.dataset.visible === "true";

      const currentId = container.dataset.videoId;

      if (isVisible && currentId === video.id) {

        container.innerHTML = "";

        container.style.display = "none";

        container.dataset.visible = "false";

        container.dataset.videoId = "";

        return;

      }

      showInlinePlayer(container, video);

    }



    function computeStats(list) {

      if (!list.length) return { avg: 0, median: 0 };

      const mins = list.map((v) => v.durationMinutes).filter((n) => Number.isFinite(n)).sort((a, b) => a - b);

      if (!mins.length) return { avg: 0, median: 0 };

      const sum = mins.reduce((a, b) => a + b, 0);

      const avg = sum / mins.length;

      const mid = Math.floor((mins.length - 1) / 2);

      const median =

        mins.length % 2 === 1 ? mins[mid] : (mins[mid + 1] + mins[mid]) / 2;

      return { avg, median };

    }



    function sortVideos(list, mode, targetMinutes) {

      const copy = [...list];

      if (mode === "closest") {

        return copy.sort((a, b) => {

          const da = Math.abs(a.durationMinutes - targetMinutes);

          const db = Math.abs(b.durationMinutes - targetMinutes);

          return da - db;

        });

      }

      if (mode === "views") {

        return copy.sort((a, b) => (Number(b.views || 0) || 0) - (Number(a.views || 0) || 0));

      }

      if (mode === "date") {

        return copy.sort(

          (a, b) =>

            new Date(b.publishedAt || 0).getTime() - new Date(a.publishedAt || 0).getTime()

        );

      }

      return copy.sort((a, b) => (a.order || 0) - (b.order || 0)); // relevance: keep API order

    }



    function applyFilters(videos, { minMinutes, maxMinutes, targetMinutes, excludeShorts, minViews, minLikes, requireHd, sortMode }) {

      let excludedByTime = 0;

      let excludedByShorts = 0;

      let excludedByEngagement = 0;



      const filtered = videos.filter((video) => {

        const dur = video.durationMinutes;

        if (!Number.isFinite(dur)) {

          excludedByTime++;

          return false;

        }

        if (dur < minMinutes || dur > maxMinutes) {

          excludedByTime++;

          return false;

        }

        if (excludeShorts && dur < 1) {

          excludedByShorts++;

          return false;

        }

        if (requireHd && video.definition !== "hd") {

          return false;

        }

        if (Number.isFinite(minViews) && minViews > 0 && Number(video.views || 0) < minViews) {

          excludedByEngagement++;

          return false;

        }

        if (Number.isFinite(minLikes) && minLikes > 0 && Number(video.likes || 0) < minLikes) {

          excludedByEngagement++;

          return false;

        }

        return true;

      });



      const sorted = sortVideos(filtered, sortMode, targetMinutes);

      return { filtered: sorted, excludedByTime, excludedByShorts, excludedByEngagement };

    }



    async function searchYouTubeVideos(query, maxResults, pageToken = "", publishedAfter = "", definition = "any") {

      const encodedQuery = encodeURIComponent(query);

      const url =

        "https://www.googleapis.com/youtube/v3/search" +

        "?part=snippet" +

        "&type=video" +

        "&maxResults=" +

        maxResults +

        "&q=" +

        encodedQuery +

        (publishedAfter ? "&publishedAfter=" + encodeURIComponent(publishedAfter) : "") +

        (definition === "hd" ? "&videoDefinition=high" : "") +

        (pageToken ? "&pageToken=" + encodeURIComponent(pageToken) : "") +

        "&key=" +

        encodeURIComponent(YT_API_KEY);



      const response = await fetch(url);

      if (!response.ok) {

        throw new Error("YouTube search request failed with status " + response.status);

      }

      const data = await response.json();

      return { items: data.items || [], nextPageToken: data.nextPageToken || "" };

    }



    async function fetchVideoDetails(ids) {

      if (!ids.length) return [];

      const url =

        "https://www.googleapis.com/youtube/v3/videos" +

        "?part=snippet,contentDetails,statistics" +

        "&id=" +

        encodeURIComponent(ids.join(",")) +

        "&key=" +

        encodeURIComponent(YT_API_KEY);



      const response = await fetch(url);

      if (!response.ok) {

        throw new Error("YouTube videos request failed with status " + response.status);

      }

      const data = await response.json();

      return data.items || [];

    }



        function renderResults(filtered, targetMinutes, toleranceMinutes, totalFetched, stats = {}) {

      clearResults();



      if (!filtered.length) {

        resultsMetaEl.textContent =

          "No videos found in the time window around " +

          targetMinutes +

          " minutes. You can try increasing the tolerance or max results.";

        return;

      }



      resultsMetaEl.textContent =

        "Showing " +

        filtered.length +

        " videos within " +

        (toleranceMinutes === 0 ? "exactly " : "+/-" + toleranceMinutes + " minutes of ") +

        targetMinutes +

        " minutes, out of " +

        totalFetched +

        " fetched search results. " +

        (Number.isFinite(stats.avg)

          ? "Avg: " + formatMinutesMinutesAndSeconds(stats.avg) + ", median: " + formatMinutesMinutesAndSeconds(stats.median) + ". "

          : "") +

        (stats.excludedByTime || stats.excludedByShorts || stats.excludedByEngagement

          ? "Filtered out - time: " +

            (stats.excludedByTime || 0) +

            (stats.excludedByShorts ? ", shorts: " + stats.excludedByShorts : "") +

            (stats.excludedByEngagement ? ", engagement: " + stats.excludedByEngagement : "") +

            "."

          : "");



      const minMinutes = targetMinutes - toleranceMinutes;

      const maxMinutes = targetMinutes + toleranceMinutes;



      filtered.forEach((item) => {

        const videoId = item.id;

        const durationMinutes = item.durationMinutes || 0;

        const channel = item.channel || "Unknown channel";

        const title = item.title || "(no title)";

        const views = item.views;

        const likes = item.likes;

        const thumbUrl = item.thumb ? { url: item.thumb } : null;



        const wrapper = document.createElement("article");

        wrapper.className = "result-item";



        const thumbDiv = document.createElement("div");

        thumbDiv.className = "thumb";



        if (thumbUrl && thumbUrl.url) {

          const img = document.createElement("img");

          img.src = thumbUrl.url;

          img.alt = title || "Video thumbnail";

          thumbDiv.appendChild(img);

        }



        const infoDiv = document.createElement("div");

        infoDiv.className = "video-info";



        const inlineContainer = document.createElement("div");

        inlineContainer.className = "inline-player";

        inlineContainer.style.gridColumn = "1 / -1";



        const titleEl = document.createElement("div");

        titleEl.className = "video-title";

        titleEl.textContent = title;



        const metaEl = document.createElement("div");

        metaEl.className = "video-meta";

                metaEl.textContent =

          channel +

          " | " +

          formatMinutesMinutesAndSeconds(durationMinutes) +

          (Number.isFinite(views) ? " | " + formatNumberShort(views) + " views" : "") +

          (Number.isFinite(likes) ? " | " + formatNumberShort(likes) + " likes" : "");





        const actions = document.createElement("div");

        actions.className = "video-actions";



        const durationPill = document.createElement("span");

        const isInside =

          durationMinutes >= minMinutes && durationMinutes <= maxMinutes;

        durationPill.className = "pill " + (isInside ? "pill-ok" : "pill-off");



        const delta = durationMinutes - targetMinutes;

        durationPill.textContent = formatDeltaMinutes(delta);



        const link = document.createElement("a");

        link.className = "link-btn";

        link.href = "https://www.youtube.com/watch?v=" + encodeURIComponent(videoId);

        link.target = "_blank";

        link.rel = "noopener noreferrer";

        link.textContent = "Watch";



        const copyBtn = document.createElement("button");

        copyBtn.type = "button";

        copyBtn.className = "link-btn";

        copyBtn.style.borderColor = "#38bdf8";

        copyBtn.style.color = "#e0f2fe";

        copyBtn.style.background = "rgba(56, 189, 248, 0.08)";

        copyBtn.textContent = "Copy link";

        copyBtn.addEventListener("click", async () => {

          try {

            await navigator.clipboard.writeText(link.href);

            copyBtn.textContent = "Copied";

            setTimeout(() => (copyBtn.textContent = "Copy link"), 1200);

          } catch {

            copyBtn.textContent = "Failed";

            setTimeout(() => (copyBtn.textContent = "Copy link"), 1200);

          }

        });



        const inlineBtn = document.createElement("button");

        inlineBtn.type = "button";

        inlineBtn.className = "link-btn";

        inlineBtn.style.borderColor = "#22c55e";

        inlineBtn.style.color = "#bbf7d0";

        inlineBtn.style.background = "rgba(34, 197, 94, 0.08)";

        inlineBtn.textContent = "Watch inline";

        inlineBtn.addEventListener("click", () => {

          toggleInlinePlayer(inlineContainer, {

            id: videoId,

            title,

            channel,

            durationMinutes,

          });

        });



        actions.appendChild(durationPill);

        actions.appendChild(inlineBtn);

        actions.appendChild(copyBtn);

        actions.appendChild(link);



        infoDiv.appendChild(titleEl);

        infoDiv.appendChild(metaEl);

        infoDiv.appendChild(actions);



        wrapper.appendChild(thumbDiv);

        wrapper.appendChild(infoDiv);

        wrapper.appendChild(inlineContainer);



        resultsEl.appendChild(wrapper);

      });

    }

const seenIds = new Set();

    let lastFiltered = [];

    let lastStats = {};

    let totalFetchedCount = 0;



    function buildVideoObject(item, order) {

      const snippet = item.snippet || {};

      const contentDetails = item.contentDetails || {};

      const stats = item.statistics || {};

      const thumb =

        snippet.thumbnails &&

        (snippet.thumbnails.medium || snippet.thumbnails.default || snippet.thumbnails.high);

      return {

        id: item.id,

        title: snippet.title,

        channel: snippet.channelTitle,

        durationMinutes: parseISODurationToMinutes(contentDetails.duration || "PT0S"),

        definition: contentDetails.definition || "",

        thumb: thumb && thumb.url,

        views: Number(stats.viewCount || 0),

        likes: Number(stats.likeCount || 0),

        publishedAt: snippet.publishedAt,

        order,

      };

    }



    async function runSearchPage({ isLoadMore = false } = {}) {

      if (!currentParams) return;

      setError("");

      const {

        query,

        minutes,

        toleranceForFilter,

        maxResults,

        publishedAfter,

        definition,

        minViews,

        minLikes,

        excludeShorts,

        sortMode,

      } = currentParams;



      if (!YT_API_KEY || YT_API_KEY === "YOUR_API_KEY_HERE") {

        setError("You must put your YouTube API key in the YT_API_KEY constant at the top of this script.");

        return;

      }



      setStatus(isLoadMore ? "Loading more results..." : 'Searching YouTube for videos about "' + query + '" ...');

      submitBtn.disabled = true;

      loadMoreBtn.disabled = true;

      loadMoreBtn.style.display = "none";

      playlistBtn.disabled = true;

      copySearchBtn.disabled = true;



      try {

        const searchRes = await searchYouTubeVideos(

          query,

          maxResults,

          isLoadMore ? currentNextPageToken : "",

          publishedAfter,

          definition

        );

        if (!isLoadMore) {

          collectedVideos = [];

          seenIds.clear();

          totalFetchedCount = 0;

        }

        totalFetchedCount += (searchRes.items || []).length;

        currentNextPageToken = searchRes.nextPageToken || "";



        const ids = (searchRes.items || [])

          .map((item) => item.id && item.id.videoId)

          .filter(Boolean)

          .filter((id) => !seenIds.has(id));



        if (!ids.length && !collectedVideos.length) {

          setStatus("");

          resultsMetaEl.textContent = "No search results returned by YouTube.";

          return;

        }



        const videoDetails = await fetchVideoDetails(ids);

        videoDetails.forEach((item, idx) => {

          const video = buildVideoObject(item, collectedVideos.length + idx);

          collectedVideos.push(video);

          seenIds.add(video.id);

        });



        const toleranceMinutes = toleranceForFilter;

        const { filtered, excludedByTime, excludedByShorts, excludedByEngagement } = applyFilters(

          collectedVideos,

          {

            minMinutes: minutes - toleranceMinutes,

            maxMinutes: minutes + toleranceMinutes,

            targetMinutes: minutes,

            excludeShorts,

            minViews,

            minLikes,

            requireHd: definition === "hd",

            sortMode,

          }

        );



        lastFiltered = filtered;

        lastStats = {

          ...computeStats(filtered),

          excludedByTime,

          excludedByShorts,

          excludedByEngagement,

        };



        setStatus("");

        renderResults(filtered, minutes, toleranceMinutes, totalFetchedCount, lastStats);



        playlistBtn.disabled = filtered.length === 0;

        copySearchBtn.disabled = !query;

        loadMoreBtn.style.display = currentNextPageToken ? "flex" : "none";

        loadMoreBtn.disabled = !currentNextPageToken;

      } catch (err) {

        console.error(err);

        setStatus("");

        setError("Something went wrong: " + err.message);

      } finally {

        submitBtn.disabled = false;

      }

    }



    searchForm.addEventListener("submit", (event) => {

      event.preventDefault();

      setError("");

      clearResults();



      const query = document.getElementById("query").value.trim();

      const minutes = Number(document.getElementById("minutes").value);

      const tolerance = Number(toleranceInput.value || 0);

      const strictMatch = strictMatchInput.checked;

      const maxResults = Number(document.getElementById("maxResults").value || 25);

      const sortMode = sortModeSelect.value;

      const published = publishedSelect.value;

      const minViews = minViewsInput.value ? Number(minViewsInput.value) : undefined;

      const minLikes = minLikesInput.value ? Number(minLikesInput.value) : undefined;

      const definition = definitionSelect.value;

      const excludeShorts = excludeShortsInput.checked;



      if (!query) {

        setError("Please enter a topic.");

        return;

      }



      if (!Number.isFinite(minutes) || minutes <= 0) {

        setError("Target minutes must be a positive number.");

        return;

      }



      if (!Number.isFinite(tolerance) || tolerance < 0) {

        setError("Tolerance must be zero or a positive number.");

        return;

      }



      if (!Number.isFinite(maxResults) || maxResults < 1 || maxResults > 50) {

        setError("Max results must be between 1 and 50.");

        return;

      }



      const toleranceForFilter = strictMatch ? 0 : tolerance;

      const publishedAfter = getPublishedAfterRange(published);



      currentQuery = query;

      currentParams = {

        query,

        minutes,

        toleranceForFilter,

        maxResults,

        publishedAfter,

        definition,

        minViews,

        minLikes,

        excludeShorts,

        sortMode,

      };

      currentNextPageToken = "";

      loadMoreBtn.style.display = "none";

      loadMoreBtn.disabled = true;

      pushRecent(query);

      runSearchPage();

    });



    loadMoreBtn.addEventListener("click", () => {

      runSearchPage({ isLoadMore: true });

    });



    playlistBtn.addEventListener("click", () => {

      if (!lastFiltered.length) return;

      const ids = lastFiltered.map((v) => v.id).filter(Boolean).slice(0, 50);

      if (!ids.length) return;

      const url = "https://www.youtube.com/watch_videos?video_ids=" + ids.join(",");

      window.open(url, "_blank", "noopener,noreferrer");

    });



    function buildShareLink() {

      if (!currentParams) return "";

      const params = new URLSearchParams();

      params.set("q", currentParams.query);

      params.set("minutes", currentParams.minutes);

      params.set("tol", currentParams.toleranceForFilter);

      params.set("sort", currentParams.sortMode);

      params.set("pub", publishedSelect.value);

      params.set("def", currentParams.definition);

      if (currentParams.excludeShorts) params.set("excludeShorts", "1");

      if (currentParams.minViews) params.set("minViews", currentParams.minViews);

      if (currentParams.minLikes) params.set("minLikes", currentParams.minLikes);

      return location.origin + location.pathname + (params.toString() ? "?" + params.toString() : "");

    }



    copySearchBtn.addEventListener("click", async () => {

      const link = buildShareLink();

      if (!link) return;

      try {

        await navigator.clipboard.writeText(link);

        copySearchBtn.textContent = "Copied";

        setTimeout(() => (copySearchBtn.textContent = "Copy search link"), 1400);

      } catch (err) {

        console.error(err);

        copySearchBtn.textContent = "Failed";

        setTimeout(() => (copySearchBtn.textContent = "Copy search link"), 1400);

      }

    });



    recentSelect.addEventListener("change", (e) => {

      const val = e.target.value;

      if (!val) return;

      const queryInput = document.getElementById("query");

      queryInput.value = val;

      queryInput.focus();

    });



    document.addEventListener("keydown", (e) => {

      if (e.key === "/" && document.activeElement.tagName !== "INPUT" && document.activeElement.tagName !== "SELECT") {

        e.preventDefault();

        document.getElementById("query").focus();

      }

      if (e.key === "l" && e.altKey && currentNextPageToken) {

        e.preventDefault();

        runSearchPage({ isLoadMore: true });

      }

      if (e.key === "p" && e.altKey && lastFiltered.length) {

        e.preventDefault();

        playlistBtn.click();

      }

    });



    themeToggle.addEventListener("click", () => {

      const next = document.body.classList.contains("light") ? "dark" : "light";

      applyTheme(next);

      localStorage.setItem(THEME_KEY, next);

    });



    initTheme();

    loadMoreBtn.style.display = "none";

    seedRecentSelect();

  </script>

</body>

</html>

