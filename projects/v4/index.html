<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Facility Janitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar" id="topbar">
    <div class="brand">Facility Janitor <span class="muted small">- Unit J-17</span></div>
    <div class="controls">
      <label>Seed
        <input id="seedInput" type="text" placeholder="random # or word" autocomplete="off" autocorrect="off" spellcheck="false" />
      </label>
      <button id="newRunBtn">New Run</button>
      <button id="restartBtn">Redeploy</button>

      <!-- Music toggle (persisted) -->
      <button id="musicBtn" aria-pressed="false" title="Toggle music">Music: Off</button>

      <span class="spacer"></span>

      <!-- Noise meter -->
      <div class="meterWrap" title="Recent noise (per try)">
        <div class="meter" id="noiseMeter">
          <div class="meter__fill" id="noiseFill"></div>
        </div>
        <span id="hudNoise" class="muted small">Noise 0</span>
      </div>

      <span id="hudLevel">Level 1</span>
      <span id="hudObjectives">Research 0/0</span>
      <span id="hudKeys">Cards 0/0</span>
      <span id="hudTools">Beacon:0 Pulse:0 Foam:0 Throws:0 Clamp:0</span>
      <span id="hudPar">Par 0:00</span>
      <span id="hudLight">Light 100%</span>
      <span id="hudDeaths">Deaths L:0 / Run:0</span>
    </div>
  </header>

  <main class="wrap" id="wrap">
    <div class="stage" id="stage">
      <canvas id="game" width="1500" height="800"></canvas>
    </div>

    <aside class="panel" id="sidebar">
      <details class="blk" open>
        <summary>Controls</summary>
        <ul class="tight">
          <li>Move — WASD or Arrow Keys</li>
          <li>Sneak — Shift</li>
          <li>Dash — Space (short burst, 1.6s cd)</li>
          <li>Trash-Can Mode — <strong>Hold T</strong> (invisible, can’t move)</li>
          <li>Throw Distraction — <strong>F</strong> or Right-Click</li>
          <li>Shutdown Clamp — <strong>E</strong> (while touching)</li>
          <li>Pick up — roll over research or keycards</li>
          <li>Exit — reach green door after all research</li>
        </ul>
      </details>

      <details class="blk" open>
        <summary>Tools</summary>
        <ul class="tight">
          <li>Decoy Beacon: <strong>1</strong> (Draws Seekers)</li>
          <li>Flash Pulse: <strong>2</strong> (Blindness)</li>
          <li>Mop Foam: <strong>3</strong> (Slow)</li>
          <li>Throw Distraction: <strong>F</strong> or Right-Click (Noise)</li>
          <li>Shutdown Clamp: <strong>E</strong> (while touching) (Disable)</li>
        </ul>
      </details>

      <details class="blk">
        <summary>Quick Tips</summary>
        <ul class="tight">
          <li>Colored Safe Zone borders match keycards. Hide inside to recharge tools.</li>
          <li>Cones stop at walls. Use corners and foam to slip by.</li>
          <li>Seekers chase noises; patrollers follow routes; cameras sweep; slimes drift.</li>
          <li>Light drains while sprinting; cameras ignore light.</li>
          <li>Keycards unlock their color-matched Safe Zone.</li>
        </ul>
      </details>

      <details class="blk">
        <summary>Enemy Cheat Sheet</summary>
        <ul class="tight">
          <li><strong>Patroller:</strong> loops on a route.</li>
          <li><strong>Sentry:</strong> rotates; long stare.</li>
          <li><strong>Seeker:</strong> hunts noises; wanders when bored.</li>
          <li><strong>Slime:</strong> drifts; short sight.</li>
          <li><strong>Camera:</strong> narrow, long sweep; ignores light.</li>
        </ul>
      </details>

      <details class="blk">
        <summary>Badges &amp; Scoring</summary>
        <ul class="tight">
          <li><strong>Ghost</strong> — No detections in the entire run.</li>
          <li><strong>Pacifist</strong> — No Shutdown Clamp used.</li>
          <li><strong>Minimalist</strong> — No tools used at all.</li>
          <li><strong>Speedrunner</strong> — ≤70% of par time.</li>
          <li><strong>Silent</strong> — Total noise under the cap.</li>
          <li><strong>Efficient Path</strong> — Close to optimal route.</li>
          <li><strong>All Clear</strong> — Enter each unlocked Safe Zone.</li>
          <li><strong>One-Take</strong> — No deaths &amp; no detections.</li>
          <li><strong>Facility Janitor</strong> — All research + keycards, no tools, no deaths.</li>
          <li><strong>Full Sanitation</strong> — Clamp every hostile (cameras too).</li>
        </ul>
      </details>
    </aside>
  </main>

  <footer class="bott" id="footer">
    <small>Corporate science made a mess. Unit J-17 cleans it before the big bosses notice. Gather research, swipe keycards, evade specimens and cameras, and extract quietly. Tense moments affect the background music. Seeded runs for repeatable puzzles.</small>
  </footer>

  <!-- Start Game Modal -->
  <div class="modal hide" id="startModal" aria-hidden="true" inert>
    <div class="modal__scrim"></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="startTitle">
      <h2 id="startTitle">Facility Janitor <span class="muted small">— Unit J-17 briefing</span></h2>

      <div>
        <section>
          <p><strong>Situation:</strong> Middle management greenlit a “cost-effective” specimen trial without telling anyone. Labs are a mess, cameras are tattling, and the boss arrives in… let’s say “soon.”</p>
          <p><strong>Objective:</strong> Retrieve scattered <strong>research</strong>, swipe <strong>keycards</strong> to unlock color-matched <strong>Safe Zones</strong> (tool recharge &amp; cover), then reach the exit before anyone notices.</p>
          <p><strong>Directive:</strong> Avoid detections. Use tools… sparingly. <em>“Minimize specimen loss.”</em> But if a clamp “accidentally” slips, we’ll file it under “preventative maintenance.”</p>

          <h3 class="h3">Quick Guide</h3>
          <ul class="tight">
            <li>Start hidden in <strong>Trash-Can Mode</strong>; move once to pop out. Hold <strong>T</strong> any time to hide (no movement while hidden).</li>
            <li><strong>Shift</strong> to sneak; <strong>Space</strong> to dash. Distractions pull Seekers; foam slows; flash blinds.</li>
          </ul>
        </section>

        <details class="blk">
          <summary>Tool Cart</summary>
          <ul class="tight">
            <li><strong>Trash-Can Mode (Hold T):</strong> Invisible while stationary.</li>
            <li><strong>Decoy Beacon (1):</strong> Chirps; Seekers investigate.</li>
            <li><strong>Flash Pulse (2):</strong> Brief blind around J-17.</li>
            <li><strong>Mop Foam (3):</strong> Slow field.</li>
            <li><strong>Throw Distraction (F / Right-Click):</strong> Tossed noise source.</li>
            <li><strong>Shutdown Clamp (E on contact):</strong> Hard disable. “Minimize creature loss,” they said. Desperate measures permitted.</li>
          </ul>
        </details>

        <details class="blk">
          <summary>Enemy Cheat Sheet</summary>
          <ul class="tight">
            <li><strong>Patroller:</strong> loops on a route.</li>
            <li><strong>Sentry:</strong> rotates; long stare.</li>
            <li><strong>Seeker:</strong> hunts noises; wanders when bored.</li>
            <li><strong>Slime:</strong> drifts; short sight.</li>
            <li><strong>Camera:</strong> narrow, long sweep; ignores light.</li>
          </ul>
        </details>
     

      <details class="blk">
        <summary>Badges &amp; Scoring</summary>
        <ul class="tight">
          <li><strong>Ghost</strong> — No detections in the entire run.</li>
          <li><strong>Pacifist</strong> — No Shutdown Clamp used.</li>
          <li><strong>Minimalist</strong> — No tools used at all.</li>
          <li><strong>Speedrunner</strong> — ≤70% of par time.</li>
          <li><strong>Silent</strong> — Total noise under the cap.</li>
          <li><strong>Efficient Path</strong> — Close to optimal route.</li>
          <li><strong>All Clear</strong> — Enter each unlocked Safe Zone.</li>
          <li><strong>One-Take</strong> — No deaths &amp; no detections.</li>
          <li><strong>Facility Janitor</strong> — All research + keycards, no tools, no deaths.</li>
          <li><strong>Full Sanitation</strong> — Clamp every hostile (cameras too).</li>
        </ul>
      </details>
 </div>
            <div>Enter a <strong>Seed</strong> to play the same layout - <strong>Play Random</strong> for a random seed - Or learn by playing the <strong>Tutorial</strong>.</div>

      <div class="row gap">
        <input id="startSeedInput" type="text" placeholder="Enter a seed for layout" autocomplete="off" autocorrect="off" spellcheck="false" />
        <button id="startSeedBtn">Play Seed</button>
        <button id="startRandomBtn">Play Random</button>
        <button id="startTutorialBtn" class="primary" title="Play five guided tutorial levels">Play Tutorial</button>
      </div>
    </div>
  </div>

  <!-- Level End Modal -->
  <div class="modal hide" id="endModal" aria-hidden="true" inert>
    <div class="modal__scrim"></div>
    <div class="modal__dialog modal__dialog--compact" role="dialog" aria-modal="true" aria-labelledby="endTitle">
      <div class="endhead">
        <div class="rankBadge" id="endRank">A</div>
        <div class="endtitle">
          <h2 id="endTitle">Level Clear — Report</h2>
          <div class="scoreline"><span id="endScore">2,430</span> pts</div>
          <div class="muted small">Seed: <span id="endSeed"></span></div>
        </div>
      </div>

      <div class="grid breakdown" id="endBreakdown"></div>
      <div class="feats" id="endFeats"></div>

      <hr />

      <div class="row wrap gap top">
        <button id="btnNextLevel" class="primary">Next Level</button>
        <button id="btnRetry">Retry</button>
        <button id="btnCopySeed">Copy Seed</button>
        <button id="btnCopyShare">Copy Share</button>
      </div>

      <hr />

      <div class="row gap">
        <input id="anotherSeedInput" type="text" placeholder="Play another seed…" autocomplete="off" autocorrect="off" spellcheck="false" />
        <button id="btnPlaySeed">Start Seed</button>
        <button id="btnPlayRandom">Random Seed</button>
      </div>
    </div>
  </div>

  <!-- Background music element (prefer MP3, then WAV) -->
  <audio id="bgm" loop preload="auto" aria-hidden="true">
    <source src="audio/theme.mp3" type="audio/mpeg">
    <source src="audio/theme.wav" type="audio/wav">
  </audio>

  <!-- Game -->
  <script src="script.js"></script>

  <!-- Music + SFX controller (minimal; does not touch your CSS/HTML text) -->
  <script>
    (function () {
      const btn  = document.getElementById('musicBtn');
      const bgm  = document.getElementById('bgm');
      if (!btn || !bgm) return;

      // Your requested overall loudness
      bgm.volume = 0.015;

      // Web Audio graph
      let ctx, media, filter, gain;
      function ensureCtx() {
        if (ctx) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        media  = ctx.createMediaElementSource(bgm);
        filter = ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 5500;
        gain   = ctx.createGain();         gain.gain.value = 1.0;
        media.connect(filter).connect(gain).connect(ctx.destination);
      }

      // Toggle & persistence
      let enabled = (localStorage.getItem('fj_bgm') ?? 'on') === 'on';
      function updateUI(){ btn.textContent = 'Music: ' + (enabled ? 'On' : 'Off'); btn.setAttribute('aria-pressed', enabled); }
      updateUI();

      // Start when loaded (helps local files); also log errors for debugging
      bgm.addEventListener('canplaythrough', () => { if (enabled) playIfEnabled(); }, { once: true });
      bgm.addEventListener('error', () => console.warn('BGM load error:', bgm.error), { once: true });
      try { bgm.load(); } catch {}

      async function playIfEnabled(){
        if (!enabled) { bgm.pause(); return; }
        ensureCtx();
        try { await ctx.resume(); await bgm.play(); } catch {}
      }

      btn.addEventListener('click', () => {
        enabled = !enabled;
        localStorage.setItem('fj_bgm', enabled ? 'on' : 'off');
        updateUI();
        if (enabled) playIfEnabled(); else bgm.pause();
      });

      // Autoplay unlock on first pointer
      const unlock = () => { if (enabled) playIfEnabled(); window.removeEventListener('pointerdown', unlock); };
      window.addEventListener('pointerdown', unlock, { once: true });

      // Also unlock when starting from modals/topbar buttons
      ['startSeedBtn','startRandomBtn','startTutorialBtn','newRunBtn'].forEach(id=>{
        const el=document.getElementById(id);
        if (el) el.addEventListener('click', ()=>enabled&&playIfEnabled(), { once:true });
      });

      // Music state exposed to game
      const state = { modal:false, inSafe:false, hiding:true, tension:0 };
      function clamp(v,a,b){ return v<a?a: v>b?b: v; }
      function computeTargets(){
        let rate = 1.0, cutoff = 5500, g = 1.0;
        if (state.modal)      { rate = 0.85; cutoff = 2200; g = 0.92; }
        else if (state.inSafe){ rate = 0.96; cutoff = 3800; }
        else if (state.hiding){ rate = 0.94; cutoff = 4200; }
        if (!state.modal) {
          const t = clamp(state.tension, 0, 1);
          rate   = clamp(rate + 0.05 + 0.15*t, 0.75, 1.25);
          cutoff = cutoff + (6500 - cutoff) * t;
        }
        return { rate, cutoff, g };
      }
      function tick(){
        if (!ctx){ requestAnimationFrame(tick); return; }
        const target = computeTargets();
        bgm.playbackRate       += (target.rate   - bgm.playbackRate) * 0.12;
        filter.frequency.value += (target.cutoff - filter.frequency.value) * 0.15;
        gain.gain.value        += (target.g      - gain.gain.value) * 0.08;
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      // tiny synth SFX
      function env(fn, dur=0.2){ ensureCtx(); const t0=ctx.currentTime; const g=ctx.createGain(); g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(1,t0+0.01); g.gain.exponentialRampToValueAtTime(0.001,t0+dur); const n=fn(t0,dur); n.connect(g).connect(ctx.destination); setTimeout(()=>{try{n.stop();}catch{}}, dur*1000+10); }
      function osc(type,f0,f1,dur=0.15){ return (t0)=>{ const o=ctx.createOscillator(); o.type=type; o.frequency.setValueAtTime(Math.max(1,f0),t0); if(f1!=null) o.frequency.exponentialRampToValueAtTime(Math.max(1,f1), t0+dur); o.start(t0); o.stop(t0+dur); return o; }; }
      function noise(dur=0.12, lp=2000){ const N=Math.floor(ctx.sampleRate*dur); const b=ctx.createBuffer(1,N,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<N;i++) d[i]=(Math.random()*2-1)*0.6; const src=ctx.createBufferSource(); src.buffer=b; const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=lp; const g=ctx.createGain(); g.gain.value=0.25; src.connect(f).connect(g).connect(ctx.destination); src.start(); src.stop(ctx.currentTime+dur); return {stop(){}}; }

      function sfx(name){
        if (!enabled) return;
        ensureCtx();
        switch(name){
          case 'death':  env(osc('square', 800, 160, 0.22), 0.22); break;
          case 'exit':   env(osc('triangle', 600, 900, 0.12), 0.12); setTimeout(()=>env(osc('triangle', 900, 1200, 0.08),0.08), 70); break;
          case 'beacon': env(osc('square', 1200, 1000, 0.10), 0.10); break;
          case 'flash':  noise(0.08, 4200); env(osc('triangle', 700, 600, 0.07), 0.07); break;
          case 'foam':   noise(0.18, 900); break;
          case 'throw':  env(osc('square', 2000, 2300, 0.06), 0.06); break;
          case 'clamp':  env(osc('square', 900, 600, 0.09), 0.09); setTimeout(()=>env(osc('square', 600, 450, 0.07), 0.07), 60); break;
          case 'pickup': env(osc('triangle', 900, 1200, 0.08), 0.08); break;   // research
          case 'card':   env(osc('square',   700, 1100, 0.10), 0.10); break;   // keycard
          case 'safe':   env(osc('sine',     500,  800,  0.12), 0.12); break;  // enter safe zone
        }
      }

      // API for game
      window.FJMusic = {
        state(next){ ensureCtx(); Object.assign(state, next||{}); if (ctx.state === 'suspended') ctx.resume(); },
        sfx,
        setEnabled(on){ enabled=!!on; localStorage.setItem('fj_bgm', on?'on':'off'); updateUI(); if (enabled) playIfEnabled(); else bgm.pause(); }
      };
    })();
  </script>
</body>
</html>
